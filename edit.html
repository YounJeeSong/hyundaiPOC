<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 수정 - 현대자동차 R&D</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        :root {
            --hyundai-blue: #002c5f;
            --white: #ffffff;
            --black: #000000;
            --hyundai-sand: #e4dcd3;
            --hyundai-light-sand: #f6f3f2;
            --grey-dark: #676767;
            --grey-light: #cccccc;
            --progressive-blue: #00aad2;
            --active-red: #e63312;
            --grey-f9: #f9f9f9;
            --grey-66: #666666;
            --grey-33: #333333;
            --success-green: #28a745;
            --warning-yellow: #f9a825;
            
            --font-text: 'Noto Sans KR', sans-serif;
            --shadow-sm: 0 2px 4px rgba(0, 44, 95, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 44, 95, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 44, 95, 0.15);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --grid-size: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-text);
            font-size: 14px;
            line-height: 1.5;
            color: var(--black);
            background: var(--hyundai-light-sand);
        }

        .app-container { display: flex; height: 100vh; overflow: hidden; }

        /* Global Navigation - 시뮬레이션 스타일 통일 */
        .global-nav {
            width: 240px;
            background: #002c5f;
            color: #fff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .logo-area {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-title { font-size: 20px; font-weight: 500; }
        .logo-subtitle { font-size: 14px; opacity: 0.7; margin-top: 4px; }

        .nav-menu { flex: 1; padding: 16px; }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #fff;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.3s ease;
            margin-bottom: 4px;
        }

        .nav-item:hover { background: rgba(255, 255, 255, 0.1); }
        .nav-item.active { background: #00aad2; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Top Bar - Edit Mode */
        .top-bar {
            background: var(--white);
            border-bottom: 1px solid var(--hyundai-sand);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .page-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--hyundai-blue);
        }

        .edit-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: var(--warning-yellow);
            color: var(--white);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .top-bar-spacer { flex: 1; }

        .action-buttons { display: flex; gap: 8px; }

        .btn {
            padding: 10px 20px;
            border: 1px solid var(--hyundai-sand);
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-primary {
            background: var(--hyundai-blue);
            color: var(--white);
            border: none;
        }

        .btn-primary:hover { background: #001f43; }

        .btn-outline {
            background: var(--white);
            color: var(--grey-66);
        }

        .btn-outline:hover { background: var(--hyundai-light-sand); }

        /* Content Area */
        .content-area { flex: 1; display: flex; overflow: hidden; }

        /* Left Panel - Card List for Edit */
        .edit-left-panel {
            width: 300px;
            background: var(--white);
            border-right: 1px solid var(--hyundai-sand);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 16px;
            border-bottom: 1px solid var(--hyundai-sand);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--hyundai-blue);
            margin-bottom: 12px;
        }

        .panel-buttons { display: flex; gap: 8px; }

        .btn-sm {
            flex: 1;
            padding: 10px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition-fast);
        }

        .btn-sm-primary {
            background: var(--progressive-blue);
            color: var(--white);
            border: none;
        }

        .btn-sm-primary:hover { background: #0099bb; }

        .btn-sm-outline {
            background: var(--white);
            color: var(--grey-66);
            border: 1px solid var(--hyundai-sand);
        }

        .btn-sm-outline:hover { background: var(--hyundai-light-sand); }

        /* Card List */
        .card-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .card-list-item {
            padding: 12px;
            background: var(--hyundai-light-sand);
            border: 1px solid var(--hyundai-sand);
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: grab;
            transition: var(--transition-fast);
        }

        .card-list-item:hover { background: var(--hyundai-sand); }

        .card-list-item.on-canvas {
            border-color: var(--success-green);
            background: rgba(40, 167, 69, 0.1);
        }

        .card-list-item-name {
            font-weight: 500;
            color: var(--hyundai-blue);
            margin-bottom: 4px;
            font-size: 13px;
        }

        .card-list-item-info {
            font-size: 11px;
            color: var(--grey-66);
        }

        /* Tools Panel */
        .tools-panel {
            padding: 16px;
            border-top: 1px solid var(--hyundai-sand);
            background: var(--grey-f9);
        }

        .tools-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--grey-66);
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .tool-buttons { display: flex; gap: 8px; flex-wrap: wrap; }

        .tool-btn {
            padding: 8px 12px;
            background: var(--white);
            border: 1px solid var(--hyundai-sand);
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition-fast);
        }

        .tool-btn:hover { background: var(--hyundai-light-sand); }

        .tool-btn.active {
            background: var(--progressive-blue);
            color: var(--white);
            border-color: var(--progressive-blue);
        }

        /* Canvas Container */
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #f0f0f0;
        }

        .canvas {
            width: 100%;
            height: 100%;
            position: relative;
            background-image: 
                linear-gradient(rgba(200,200,200,0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200,200,200,0.3) 1px, transparent 1px);
            background-size: var(--grid-size) var(--grid-size);
            cursor: grab;
        }

        .canvas:active { cursor: grabbing; }

        .canvas-inner {
            position: absolute;
            width: 1200px;
            height: 800px;
            transform-origin: 0 0;
        }

        .canvas-bg-image {
            position: absolute;
            pointer-events: none;
            opacity: 1;
        }

        .canvas-bg-image.anchor-mode {
            pointer-events: auto;
            cursor: crosshair;
        }

        /* Canvas Cards */
        .canvas-card {
            position: absolute;
            background: var(--white);
            border: 1px solid var(--hyundai-sand);
            border-radius: 6px;
            box-shadow: var(--shadow-md);
            min-width: 200px;
            max-width: 220px;
            z-index: 10;
            transition: left 0.2s ease, top 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .canvas-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--progressive-blue);
        }

        .canvas-card.selected {
            border: 2px solid var(--progressive-blue);
            box-shadow: 0 4px 16px rgba(0, 170, 210, 0.3);
        }

        .canvas-card.connected {
            border: 2px solid var(--success-green);
        }

        .canvas-card.dragging {
            opacity: 0.9;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            transition: none;
        }

        .canvas-card-header {
            padding: 10px 14px;
            background: var(--hyundai-light-sand);
            border-bottom: 1px solid var(--hyundai-sand);
            border-radius: 6px 6px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .canvas-card-info { flex: 1; }

        .canvas-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--grey-33);
        }

        .canvas-card-subtitle {
            font-size: 11px;
            color: var(--grey-66);
            margin-top: 2px;
        }

        .canvas-card-actions { display: flex; gap: 4px; }

        .card-action-btn {
            width: 24px;
            height: 24px;
            background: var(--white);
            border: 1px solid var(--hyundai-sand);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .card-action-btn:hover { background: var(--hyundai-light-sand); }
        .card-action-btn.delete:hover {
            background: #ffebee;
            border-color: var(--active-red);
            color: var(--active-red);
        }

        .canvas-card-body { padding: 10px 14px; }

        .canvas-param-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid var(--hyundai-light-sand);
        }

        .canvas-param-row:last-child { border-bottom: none; }
        .canvas-param-name { color: var(--grey-66); }
        .canvas-param-value {
            font-weight: 600;
            color: var(--grey-33);
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .param-input {
            width: 80px;
            padding: 2px 6px;
            border: 1px solid var(--hyundai-sand);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            text-align: right;
            background: var(--white);
            color: var(--grey-33);
        }

        .param-input:focus {
            outline: none;
            border-color: var(--hyundai-blue);
            box-shadow: 0 0 0 2px rgba(0, 44, 95, 0.1);
        }

        .param-unit {
            color: var(--grey-66);
            font-size: 11px;
        }

        /* Anchor Points */
        .anchor-point {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--active-red);
            border: 2px solid var(--white);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 20;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
        }

        .anchor-point:hover { transform: translate(-50%, -50%) scale(1.2); }

        .anchor-point.dragging {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.3);
        }

        .anchor-point::after {
            content: attr(data-label);
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--active-red);
            color: var(--white);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Connection Lines */
        .connection-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 2000px;
            height: 2000px;
            pointer-events: none;
            z-index: 5;
            overflow: visible;
        }

        .connection-line {
            stroke: var(--active-red);
            stroke-width: 2;
            fill: none;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: var(--white);
            border: 1px solid var(--hyundai-sand);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--grey-66);
            transition: var(--transition-fast);
        }

        .zoom-btn:hover {
            background: var(--hyundai-blue);
            color: var(--white);
            border-color: var(--hyundai-blue);
        }

        .zoom-level {
            background: var(--white);
            border: 1px solid var(--hyundai-sand);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            color: var(--grey-66);
        }

        /* Save Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: var(--white);
            border-radius: 8px;
            width: 90%;
            max-width: 450px;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--hyundai-sand);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--hyundai-blue);
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--grey-66);
            padding: 4px;
        }

        .modal-body { padding: 24px; }

        .modal-text {
            font-size: 14px;
            color: var(--grey-66);
            line-height: 1.6;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--hyundai-sand);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="global-nav">
            <div class="logo-area">
                <div class="logo-title">R&D Parameter DB</div>
                <div class="logo-subtitle">현대자동차</div>
            </div>
                        <div class="nav-menu">
                <div class="nav-item active" onclick="location.href='index.html'">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    데이터조회
                </div>
                <div class="nav-item" onclick="location.href='create-step1.html'">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                    데이터 생성
                </div>
                <div class="nav-item" onclick="location.href='kpi-analysis.html'">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    해석
                </div>
                <div class="nav-item" onclick="location.href='simulation-setup.html'">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                    </svg>
                    시뮬레이션
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="page-title-section">
                    <h1 class="page-title">2025 GV90 전륜 서스펜션 시스템</h1>
                    <span class="edit-badge">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                        </svg>
                        수정 모드
                    </span>
                </div>
                <div class="top-bar-spacer"></div>
                <div class="action-buttons">
                    <button class="btn btn-outline" onclick="cancelEdit()">취소</button>
                    <button class="btn btn-primary" onclick="saveChanges()">저장</button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Left Panel - Card List -->
                <div class="edit-left-panel">
                    <div class="panel-header">
                        <div class="panel-title">파라미터 세트</div>
                        <div class="panel-buttons">
                            <button class="btn-sm btn-sm-primary" onclick="addAllToCanvas()">전체 배치</button>
                            <button class="btn-sm btn-sm-outline" onclick="clearCanvas()">초기화</button>
                        </div>
                    </div>
                    <div class="card-list" id="cardList">
                        <!-- Dynamic content -->
                    </div>
                    <div class="tools-panel">
                        <div class="tools-title">도구</div>
                        <div class="tool-buttons">
                            <button class="tool-btn" id="anchorModeBtn" onclick="toggleAnchorMode()">
                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                </svg>
                                앵커 추가
                            </button>
                            <button class="tool-btn" onclick="clearAllAnchors()">
                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9z" clip-rule="evenodd"/>
                                </svg>
                                앵커 삭제
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="canvas-container">
                    <div class="canvas" id="canvas">
                        <div class="canvas-inner" id="canvasInner">
                            <!-- Connection Lines SVG -->
                            <svg class="connection-lines" id="connectionLines"></svg>
                            
                            <!-- Background Image -->
                            <img src="Suspension.png" 
                                 alt="Suspension" 
                                 class="canvas-bg-image" 
                                 style="left: 280px; top: 120px; max-width: 500px;"
                                 id="canvasBgImage">
                            
                            <!-- Anchor Points rendered dynamically -->
                            <div id="anchorContainer"></div>
                            
                            <!-- Canvas Cards rendered dynamically -->
                            <div id="canvasCards"></div>
                        </div>
                    </div>

                    <!-- Zoom Controls -->
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomIn()">+</button>
                        <div class="zoom-level" id="zoomLevel">100%</div>
                        <button class="zoom-btn" onclick="zoomOut()">−</button>
                        <button class="zoom-btn" onclick="resetZoom()">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Cancel Confirm Modal -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">수정 취소</div>
                <button class="modal-close" onclick="closeCancelModal()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-text">변경 사항이 저장되지 않습니다. 수정을 취소하시겠습니까?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeCancelModal()">계속 수정</button>
                <button class="btn btn-primary" onclick="confirmCancel()">취소하기</button>
            </div>
        </div>
    </div>

    <!-- Save Confirm Modal -->
    <div class="modal-overlay" id="saveModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">저장 완료</div>
            </div>
            <div class="modal-body">
                <p class="modal-text">변경 사항이 저장되었습니다.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="confirmSave()">확인</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA
        // ============================================
        const cardData = [
            {
                id: 1,
                name: "LWR/ARM Static",
                subtitle: "MV, 00(프런트 60)",
                category: "static",
                params: [
                    { name: "axial P", value: "5.5", unit: "kg/mm" },
                    { name: "lowest P1", value: "55.1", unit: "" },
                    { name: "lateral P2", value: "91.1", unit: "" },
                    { name: "axial Q", value: "33", unit: "kg/mm" },
                    { name: "torsional R", value: "28.6", unit: "kgf/mm/deg" },
                    { name: "conical S1", value: "44.4", unit: "kgf/mm/deg" },
                    { name: "conical S2", value: "23.5", unit: "kgf/mm/deg" }
                ]
            },
            {
                id: 2,
                name: "MBR MTG Static",
                subtitle: "신규, 기본",
                category: "static",
                params: [
                    { name: "fore-aft P1", value: "10000", unit: "" },
                    { name: "lateral P2", value: "10000", unit: "" },
                    { name: "vertical Q", value: "10000", unit: "" },
                    { name: "torsional R", value: "10000", unit: "" },
                    { name: "conical S1", value: "10000", unit: "" },
                    { name: "conical S2", value: "10000", unit: "" }
                ]
            },
            {
                id: 3,
                name: "INSULATOR Static",
                subtitle: "GT, TA(프런트 60)",
                category: "insulator",
                params: [
                    { name: "P", value: "121", unit: "" },
                    { name: "MO/C-aft", value: "200, 85", unit: "mm" },
                    { name: "Q lateral", value: "85, 200, 10.0, 220.0", unit: "" },
                    { name: "torsional R", value: "37.0, 2000.0", unit: "" },
                    { name: "conical S1", value: "49.0, 15000.0", unit: "" }
                ]
            },
            {
                id: 7,
                name: "STAB/BAR",
                subtitle: "신규, 사앙이션 링크",
                category: "static",
                params: [
                    { name: "fore-aft P1", value: "459", unit: "" },
                    { name: "lateral P2", value: "459", unit: "" },
                    { name: "vertical Q", value: "45", unit: "" },
                    { name: "torsional R", value: "8", unit: "" },
                    { name: "conical S1", value: "10", unit: "" },
                    { name: "conical S2", value: "10", unit: "" }
                ]
            }
        ];

        // State
        let canvasCards = [];
        let anchors = [
            { id: 1, label: 'P1', x: 680, y: 420 },
            { id: 2, label: 'P2', x: 520, y: 280 },
            { id: 3, label: 'P3', x: 750, y: 320 },
            { id: 4, label: 'P4', x: 430, y: 380 }
        ];
        let connections = [];
        let anchorCounter = 5;
        
        let currentZoom = 1;
        let panX = 0, panY = 0;
        let isPanning = false;
        let startPan = { x: 0, y: 0 };
        
        let anchorMode = false;
        let selectedCard = null;
        let draggedCard = null;
        let draggedAnchor = null;
        let dragOffset = { x: 0, y: 0 };
        let canvasCardCounter = 1;

        const GRID_SIZE = 20;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            renderCardList();
            renderAnchors();
            initCanvasPan();
            loadInitialState();
        });

        function loadInitialState() {
            // localStorage에서 조회 페이지의 배치 정보 확인
            const savedLayout = localStorage.getItem('editLayoutData');
            
            if (savedLayout) {
                try {
                    const layoutData = JSON.parse(savedLayout);
                    
                    // cardData 업데이트 (파라미터 값 복원)
                    if (layoutData.cardData) {
                        layoutData.cardData.forEach(savedCard => {
                            const card = cardData.find(c => c.id === savedCard.id);
                            if (card) {
                                card.params = savedCard.params;
                            }
                        });
                    }
                    
                    // 앵커 위치 복원
                    if (layoutData.anchors) {
                        anchors = layoutData.anchors;
                    }
                    
                    // 카드 배치 복원
                    if (layoutData.canvasCards) {
                        layoutData.canvasCards.forEach(cc => {
                            const card = cardData.find(c => c.id === cc.cardId);
                            if (card) {
                                addCardToCanvas(card, cc.x, cc.y, false);
                            }
                        });
                    }
                    
                    // 연결 복원
                    if (layoutData.connections) {
                        connections = layoutData.connections;
                    }
                    
                    // zoom/pan 복원
                    if (layoutData.zoom !== undefined) {
                        currentZoom = layoutData.zoom;
                        document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
                    }
                    if (layoutData.panX !== undefined) panX = layoutData.panX;
                    if (layoutData.panY !== undefined) panY = layoutData.panY;
                    updateCanvasTransform();
                    
                    renderAnchors();
                    updateConnectionLines();
                    updateCardListStatus();
                    return;
                } catch (e) {
                    console.error('배치 정보 로드 오류:', e);
                }
            }
            
            // 기본 배치 (localStorage에 데이터 없을 경우) - 조회 페이지와 동일
            const initialCards = [
                { cardId: 1, x: 20, y: 100, anchorId: 2 },      // LWR/ARM Static 좌상단 -> P2
                { cardId: 7, x: 20, y: 450, anchorId: 4 },      // STAB/BAR 좌하단 -> P4
                { cardId: 3, x: 970, y: 100, anchorId: 3 },     // INSULATOR Static 우상단 -> P3
                { cardId: 2, x: 970, y: 450, anchorId: 1 }      // MBR MTG Static 우하단 -> P1
            ];

            initialCards.forEach(item => {
                const card = cardData.find(c => c.id === item.cardId);
                if (card) {
                    addCardToCanvas(card, item.x, item.y, false);
                    if (item.anchorId) {
                        connections.push({ cardId: card.id, anchorId: item.anchorId });
                    }
                }
            });

            updateConnectionLines();
            updateCardListStatus();
        }

        // ============================================
        // CARD LIST
        // ============================================
        function renderCardList() {
            const container = document.getElementById('cardList');
            container.innerHTML = cardData.map(card => `
                <div class="card-list-item" 
                     id="list-card-${card.id}"
                     draggable="true"
                     ondragstart="handleDragStart(event, ${card.id})"
                     onclick="toggleCardOnCanvas(${card.id})">
                    <div class="card-list-item-name">${card.name}</div>
                    <div class="card-list-item-info">${card.subtitle} · ${card.params.length}개 파라미터</div>
                </div>
            `).join('');
        }

        function toggleCardOnCanvas(cardId) {
            const card = cardData.find(c => c.id === cardId);
            if (!card) return;

            const existingCard = canvasCards.find(cc => cc.cardId === cardId);
            
            if (existingCard) {
                // 이미 배치됨 → 제거
                removeCardFromCanvas(existingCard.id);
            } else {
                // 배치되지 않음 → 자동 배치
                let x = 60, y = 100;
                const occupiedPositions = canvasCards.map(cc => ({ x: cc.x, y: cc.y }));
                
                // 빈 자리 찾기
                while (occupiedPositions.some(pos => Math.abs(pos.x - x) < 220 && Math.abs(pos.y - y) < 160)) {
                    y += 180;
                    if (y > 500) {
                        y = 100;
                        x += 250;
                    }
                }
                
                addCardToCanvas(card, x, y);
            }
        }

        function updateCardListStatus() {
            cardData.forEach(card => {
                const listItem = document.getElementById(`list-card-${card.id}`);
                const isOnCanvas = canvasCards.some(cc => cc.cardId === card.id);
                if (listItem) {
                    listItem.classList.toggle('on-canvas', isOnCanvas);
                }
            });
        }

        // ============================================
        // DRAG & DROP FROM LIST
        // ============================================
        function handleDragStart(e, cardId) {
            e.dataTransfer.setData('cardId', cardId);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('canvas');
            
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const cardId = parseInt(e.dataTransfer.getData('cardId'));
                const card = cardData.find(c => c.id === cardId);
                
                if (card && !canvasCards.some(cc => cc.cardId === cardId)) {
                    const canvasRect = canvas.getBoundingClientRect();
                    // panX, panY 오프셋을 고려한 좌표 계산
                    const x = (e.clientX - canvasRect.left - panX) / currentZoom;
                    const y = (e.clientY - canvasRect.top - panY) / currentZoom;
                    addCardToCanvas(card, x, y);
                }
            });
        });

        // ============================================
        // CANVAS CARDS
        // ============================================
        function addCardToCanvas(card, x, y, animate = true) {
            const canvasCard = {
                id: canvasCardCounter++,
                cardId: card.id,
                x: snapToGrid(x),
                y: snapToGrid(y)
            };

            canvasCards.push(canvasCard);
            renderCanvasCard(canvasCard, card, animate);
            updateCardListStatus();
        }

        function renderCanvasCard(canvasCard, card, animate) {
            const container = document.getElementById('canvasCards');
            const div = document.createElement('div');
            div.className = 'canvas-card';
            div.id = `canvas-card-${canvasCard.id}`;
            div.style.left = `${canvasCard.x}px`;
            div.style.top = `${canvasCard.y}px`;
            
            if (animate) {
                div.style.opacity = '0';
                div.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    div.style.opacity = '1';
                    div.style.transform = 'scale(1)';
                }, 10);
            }

            div.innerHTML = `
                <div class="canvas-card-header">
                    <div class="canvas-card-info">
                        <div class="canvas-card-title">${card.name}</div>
                        <div class="canvas-card-subtitle">${card.subtitle}</div>
                    </div>
                    <div class="canvas-card-actions">
                        <button class="card-action-btn delete" onclick="removeCardFromCanvas(${canvasCard.id})" title="삭제">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="canvas-card-body">
                    ${card.params.map((p, idx) => `
                        <div class="canvas-param-row">
                            <span class="canvas-param-name">${p.name}</span>
                            <span class="canvas-param-value">
                                <input type="text" class="param-input" value="${p.value}" 
                                       data-card-id="${card.id}" data-param-idx="${idx}"
                                       onchange="updateParamValue(${card.id}, ${idx}, this.value)">
                                <span class="param-unit">${p.unit}</span>
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Card selection
            div.addEventListener('click', (e) => {
                if (!e.target.closest('.card-action-btn')) {
                    selectCard(canvasCard.id);
                }
            });

            // Card dragging
            const header = div.querySelector('.canvas-card-header');
            header.addEventListener('mousedown', (e) => {
                if (e.target.closest('.card-action-btn')) return;
                startDragCard(e, canvasCard);
            });

            container.appendChild(div);
        }

        function updateParamValue(cardId, paramIdx, newValue) {
            const card = cardData.find(c => c.id === cardId);
            if (card && card.params[paramIdx]) {
                card.params[paramIdx].value = newValue;
            }
        }

        function removeCardFromCanvas(canvasCardId) {
            const element = document.getElementById(`canvas-card-${canvasCardId}`);
            const canvasCard = canvasCards.find(cc => cc.id === canvasCardId);
            
            if (element) {
                element.style.opacity = '0';
                element.style.transform = 'scale(0.9)';
                setTimeout(() => element.remove(), 200);
            }

            // Remove connections
            if (canvasCard) {
                connections = connections.filter(conn => conn.cardId !== canvasCard.cardId);
            }

            canvasCards = canvasCards.filter(cc => cc.id !== canvasCardId);
            updateConnectionLines();
            updateCardListStatus();
        }

        function selectCard(canvasCardId) {
            document.querySelectorAll('.canvas-card').forEach(c => c.classList.remove('selected'));
            
            const element = document.getElementById(`canvas-card-${canvasCardId}`);
            if (element) {
                element.classList.add('selected');
                selectedCard = canvasCardId;
            }
        }

        // ============================================
        // CARD DRAGGING
        // ============================================
        function startDragCard(e, canvasCard) {
            e.preventDefault();
            draggedCard = canvasCard;
            
            const cardElement = document.getElementById(`canvas-card-${canvasCard.id}`);
            const cardRect = cardElement.getBoundingClientRect();
            
            dragOffset.x = e.clientX - cardRect.left;
            dragOffset.y = e.clientY - cardRect.top;

            cardElement.classList.add('dragging');

            document.addEventListener('mousemove', dragCard);
            document.addEventListener('mouseup', stopDragCard);
        }

        function dragCard(e) {
            if (!draggedCard) return;

            const cardElement = document.getElementById(`canvas-card-${draggedCard.id}`);
            const canvas = document.getElementById('canvas');
            const canvasRect = canvas.getBoundingClientRect();

            // panX, panY 오프셋을 고려한 좌표 계산
            const newX = (e.clientX - canvasRect.left - panX) / currentZoom;
            const newY = (e.clientY - canvasRect.top - panY) / currentZoom;

            cardElement.style.left = `${newX}px`;
            cardElement.style.top = `${newY}px`;

            draggedCard.x = newX;
            draggedCard.y = newY;

            updateConnectionLines();
        }

        function stopDragCard(e) {
            if (!draggedCard) return;

            const cardElement = document.getElementById(`canvas-card-${draggedCard.id}`);
            
            const currentX = parseFloat(cardElement.style.left);
            const currentY = parseFloat(cardElement.style.top);

            const snappedX = snapToGrid(currentX);
            const snappedY = snapToGrid(currentY);

            draggedCard.x = snappedX;
            draggedCard.y = snappedY;

            cardElement.style.left = `${snappedX}px`;
            cardElement.style.top = `${snappedY}px`;
            cardElement.classList.remove('dragging');

            document.removeEventListener('mousemove', dragCard);
            document.removeEventListener('mouseup', stopDragCard);

            setTimeout(() => updateConnectionLines(), 200);

            draggedCard = null;
        }

        function snapToGrid(value) {
            return Math.round(value / GRID_SIZE) * GRID_SIZE;
        }

        // ============================================
        // ANCHORS
        // ============================================
        function renderAnchors() {
            const container = document.getElementById('anchorContainer');
            container.innerHTML = '';
            
            anchors.forEach(anchor => {
                const div = document.createElement('div');
                div.className = 'anchor-point';
                div.id = `anchor-${anchor.id}`;
                div.setAttribute('data-label', anchor.label);
                div.style.left = `${anchor.x}px`;
                div.style.top = `${anchor.y}px`;

                div.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleAnchorClick(anchor);
                });

                div.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    startDragAnchor(e, anchor);
                });

                container.appendChild(div);
            });
        }

        function toggleAnchorMode() {
            anchorMode = !anchorMode;
            const btn = document.getElementById('anchorModeBtn');
            const img = document.getElementById('canvasBgImage');

            btn.classList.toggle('active', anchorMode);
            img.classList.toggle('anchor-mode', anchorMode);

            if (anchorMode) {
                img.addEventListener('click', handleImageClick);
            } else {
                img.removeEventListener('click', handleImageClick);
            }
        }

        function handleImageClick(e) {
            if (!anchorMode) return;

            const canvas = document.getElementById('canvas');
            const canvasRect = canvas.getBoundingClientRect();
            
            // panX, panY 오프셋을 고려한 좌표 계산
            const x = (e.clientX - canvasRect.left - panX) / currentZoom;
            const y = (e.clientY - canvasRect.top - panY) / currentZoom;

            createAnchor(x, y);
        }

        function createAnchor(x, y) {
            const anchor = {
                id: Date.now(),
                label: `P${anchorCounter++}`,
                x: x,
                y: y
            };

            anchors.push(anchor);
            renderAnchors();
        }

        function handleAnchorClick(anchor) {
            if (!selectedCard) {
                alert('먼저 연결할 카드를 선택하세요.');
                return;
            }

            const canvasCard = canvasCards.find(c => c.id === selectedCard);
            if (!canvasCard) return;

            const cardId = canvasCard.cardId;
            const existingIndex = connections.findIndex(conn => conn.cardId === cardId);

            if (existingIndex !== -1) {
                connections[existingIndex].anchorId = anchor.id;
            } else {
                connections.push({ cardId: cardId, anchorId: anchor.id });
            }

            const cardElement = document.getElementById(`canvas-card-${selectedCard}`);
            if (cardElement) {
                cardElement.classList.remove('selected');
                cardElement.classList.add('connected');
            }

            updateConnectionLines();
            selectedCard = null;
        }

        function startDragAnchor(e, anchor) {
            e.preventDefault();
            draggedAnchor = anchor;

            const anchorElement = document.getElementById(`anchor-${anchor.id}`);
            anchorElement.classList.add('dragging');

            document.addEventListener('mousemove', dragAnchor);
            document.addEventListener('mouseup', stopDragAnchor);
        }

        function dragAnchor(e) {
            if (!draggedAnchor) return;

            const canvas = document.getElementById('canvas');
            const canvasRect = canvas.getBoundingClientRect();

            // panX, panY 오프셋을 고려한 좌표 계산
            const x = (e.clientX - canvasRect.left - panX) / currentZoom;
            const y = (e.clientY - canvasRect.top - panY) / currentZoom;

            draggedAnchor.x = x;
            draggedAnchor.y = y;

            const anchorElement = document.getElementById(`anchor-${draggedAnchor.id}`);
            anchorElement.style.left = `${x}px`;
            anchorElement.style.top = `${y}px`;

            updateConnectionLines();
        }

        function stopDragAnchor(e) {
            if (!draggedAnchor) return;

            const anchorElement = document.getElementById(`anchor-${draggedAnchor.id}`);
            anchorElement.classList.remove('dragging');

            document.removeEventListener('mousemove', dragAnchor);
            document.removeEventListener('mouseup', stopDragAnchor);

            draggedAnchor = null;
        }

        function clearAllAnchors() {
            if (!confirm('모든 앵커 포인트를 삭제하시겠습니까?')) return;

            anchors = [];
            connections = [];
            anchorCounter = 1;
            renderAnchors();
            updateConnectionLines();

            document.querySelectorAll('.canvas-card').forEach(card => {
                card.classList.remove('connected');
            });
        }

        // ============================================
        // CONNECTION LINES
        // ============================================
        function updateConnectionLines() {
            const svg = document.getElementById('connectionLines');
            svg.innerHTML = '';

            connections.forEach(conn => {
                const canvasCard = canvasCards.find(cc => cc.cardId === conn.cardId);
                const anchor = anchors.find(a => a.id === conn.anchorId);

                if (!canvasCard || !anchor) return;

                const cardElement = document.getElementById(`canvas-card-${canvasCard.id}`);
                if (!cardElement) return;

                // 카드 위치와 크기 기반으로 연결점 계산
                const cardWidth = cardElement.offsetWidth || 200;
                const cardHeight = cardElement.offsetHeight || 150;
                
                // 카드 중앙 오른쪽 또는 왼쪽 선택 (앵커 위치에 따라)
                let x1, y1;
                if (anchor.x > canvasCard.x + cardWidth / 2) {
                    // 앵커가 카드 오른쪽에 있으면 카드 오른쪽에서 연결
                    x1 = canvasCard.x + cardWidth;
                } else {
                    // 앵커가 카드 왼쪽에 있으면 카드 왼쪽에서 연결
                    x1 = canvasCard.x;
                }
                y1 = canvasCard.y + cardHeight / 2;
                
                const x2 = anchor.x;
                const y2 = anchor.y;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.classList.add('connection-line');

                svg.appendChild(line);
            });
        }

        // ============================================
        // CANVAS PAN & ZOOM
        // ============================================
        function initCanvasPan() {
            const canvas = document.getElementById('canvas');

            canvas.addEventListener('mousedown', (e) => {
                if (e.target === canvas || e.target.id === 'canvasInner') {
                    isPanning = true;
                    startPan = { x: e.clientX - panX, y: e.clientY - panY };
                    canvas.style.cursor = 'grabbing';
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isPanning) {
                    panX = e.clientX - startPan.x;
                    panY = e.clientY - startPan.y;
                    updateCanvasTransform();
                }
            });

            canvas.addEventListener('mouseup', () => {
                isPanning = false;
                canvas.style.cursor = 'grab';
            });

            canvas.addEventListener('mouseleave', () => {
                isPanning = false;
                canvas.style.cursor = 'grab';
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                currentZoom = Math.min(Math.max(currentZoom + delta, 0.5), 2);
                updateCanvasTransform();
                document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
            });
        }

        function updateCanvasTransform() {
            const inner = document.getElementById('canvasInner');
            inner.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.1, 2);
            updateCanvasTransform();
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.1, 0.5);
            updateCanvasTransform();
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function resetZoom() {
            currentZoom = 1;
            panX = 0;
            panY = 0;
            updateCanvasTransform();
            document.getElementById('zoomLevel').textContent = '100%';
        }

        // ============================================
        // BULK ACTIONS
        // ============================================
        function addAllToCanvas() {
            let x = 60;
            let y = 100;

            cardData.forEach(card => {
                if (!canvasCards.some(cc => cc.cardId === card.id)) {
                    addCardToCanvas(card, x, y);
                    y += 180;
                    if (y > 500) {
                        y = 100;
                        x += 250;
                    }
                }
            });
        }

        function clearCanvas() {
            if (!confirm('캔버스의 모든 카드를 제거하시겠습니까?')) return;

            canvasCards.forEach(cc => {
                const element = document.getElementById(`canvas-card-${cc.id}`);
                if (element) element.remove();
            });

            canvasCards = [];
            connections = [];
            updateConnectionLines();
            updateCardListStatus();
        }

        // ============================================
        // SAVE & CANCEL
        // ============================================
        function cancelEdit() {
            document.getElementById('cancelModal').style.display = 'flex';
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').style.display = 'none';
        }

        function confirmCancel() {
            // 조회 페이지로 이동
            window.location.href = 'view-detail.html';
        }

        function saveChanges() {
            // 저장 로직 - 모든 데이터 저장
            const saveData = {
                cardData: cardData,  // 파라미터 값 포함
                canvasCards: canvasCards.map(cc => ({
                    cardId: cc.cardId,
                    x: cc.x,
                    y: cc.y
                })),
                anchors: anchors,
                connections: connections
            };

            localStorage.setItem('viewerData', JSON.stringify(saveData));
            
            // 바로 조회 페이지로 이동
            window.location.href = 'view-detail.html';
        }

        function confirmSave() {
            document.getElementById('saveModal').style.display = 'none';
            window.location.href = 'view-detail.html';
        }

        // ESC to deselect
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                selectedCard = null;
                document.querySelectorAll('.canvas-card').forEach(c => c.classList.remove('selected'));
            }
        });
    </script>
</body>
</html>
